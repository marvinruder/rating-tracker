FROM node:20.0.0-alpine as yarn
ENV FORCE_COLOR true

WORKDIR /workdir

# Copy files required for installing dependencies
COPY global ./global
COPY .yarn ./.yarn
COPY package.json .yarnrc.yml yarn.lock ./
COPY packages/rating-tracker-backend/package.json ./packages/rating-tracker-backend/
COPY packages/rating-tracker-commons/package.json ./packages/rating-tracker-commons/
COPY packages/rating-tracker-frontend/package.json ./packages/rating-tracker-frontend/

# Install dependencies
RUN yarn --immutable

# Copy files required for Prisma
COPY packages/rating-tracker-backend/prisma ./packages/rating-tracker-backend/prisma
COPY packages/rating-tracker-backend/test/.env ./packages/rating-tracker-backend/test/

# Initialize Prisma for tests and generate client
RUN yarn workspace rating-tracker-backend test:prisma:migrate:init

ENTRYPOINT [ "/bin/sh" ]
