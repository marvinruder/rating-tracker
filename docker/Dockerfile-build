FROM node:20.5.0-alpine as build
LABEL stage=build
ENV NODE_ENV production
ENV FORCE_COLOR true

WORKDIR /workdir

COPY . .

# Build and create local production caches while using global mirror
RUN \
  yarn build && \
  yarn config set enableGlobalCache false && \
  yarn cache clean && \
  yarn workspaces focus --production @rating-tracker/backend

# Create directories for run container and copy only necessary files
RUN mkdir -p /workdir/app/packages/backend/public /workdir/app/packages/commons /workdir/app/.yarn && \
  cp -r /workdir/.pnp.* /workdir/package.json /workdir/app && \
  cp -r /workdir/.yarn/cache /workdir/.yarn/unplugged /workdir/app/.yarn && \
  cp -r /workdir/packages/backend/dist /workdir/packages/backend/package.json /workdir/app/packages/backend && \
  cp -r /workdir/packages/commons/dist /workdir/packages/commons/package.json /workdir/app/packages/commons && \
  cp -r /workdir/packages/frontend/dist/* /workdir/app/packages/backend/public && \
  find /workdir/app -name '*.d.ts' -type f -delete && \
  # Remove binaries of unused Selenium Manager
  rm -r /workdir/app/.yarn/unplugged/selenium-webdriver-npm-*/node_modules/selenium-webdriver/bin

ENTRYPOINT [ "/bin/sh" ]
